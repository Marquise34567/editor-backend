generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanStatus {
  free
  active
  past_due
  canceled
}

enum PlanTier {
  free
  starter
  creator
  studio
  founder
}

enum JobStatus {
  queued
  uploading
  analyzing
  hooking
  cutting
  pacing
  subtitling
  audio
  story
  retention
  rendering
  completed
  failed
}

model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  createdAt             DateTime @default(now()) @map("created_at")
  stripeCustomerId      String?  @map("stripe_customer_id")
  stripeSubscriptionId  String?  @map("stripe_subscription_id")
  stripePriceId         String?  @map("stripe_price_id")
  planStatus            PlanStatus @default(free) @map("plan_status")
  currentPeriodEnd      DateTime? @map("current_period_end")
  settings              UserSettings?
  jobs                  Job[]
  usageDaily            UsageDaily[]
  usageMonthly          UsageMonthly[]
  subscription          Subscription?
  exportCounter         ExportCounter?
  lessonProgress        LessonProgress[]
  analyticsEvents       SiteAnalyticsEvent[]

  @@map("profiles")
}

model Job {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  configVersionId String? @map("config_version_id")
  status     JobStatus @default(queued)
  inputPath  String   @map("input_url")
  outputPath String?  @map("output_url")
  inputDurationSeconds Int? @map("input_duration_seconds")
  requestedQuality String? @map("requested_quality")
  finalQuality String? @map("final_quality")
  watermarkApplied Boolean @default(false) @map("watermark_applied")
  priority   Boolean @default(false)
  priorityLevel Int @default(2) @map("priority_level")
  progress   Int      @default(0)
  error      String?
  analysis   Json?    @map("analysis")
  renderSettings Json? @map("render_settings")
  retentionScore Int? @map("retention_score")
  optimizationNotes Json? @map("optimization_notes")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  algorithmConfigVersion EditorConfigVersion? @relation("JobAlgorithmConfig", fields: [configVersionId], references: [id])
  renderQualityMetrics RenderQualityMetric[]

  @@map("jobs")
}

model VibeCutUpload {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  fileName      String       @map("file_name")
  storedPath    String       @map("stored_path")
  metadata      Json
  autoDetection Json         @map("auto_detection")
  createdAt     DateTime     @default(now()) @map("created_at")
  jobs          VibeCutJob[]

  @@index([userId, createdAt], map: "idx_vibecut_uploads_user_created_at")
  @@map("vibecut_uploads")
}

model VibeCutJob {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  uploadId       String        @map("upload_id")
  status         String
  mode           String
  progress       Int           @default(0)
  fileName       String        @map("file_name")
  outputVideoUrl String?       @map("output_video_url")
  outputVideoPath String?      @map("output_video_path")
  clipUrls       Json?         @map("clip_urls")
  ffmpegCommands Json?         @map("ffmpeg_commands")
  thumbnails     Json?
  retention      Json?
  errorMessage   String?       @map("error_message")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  upload         VibeCutUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt], map: "idx_vibecut_jobs_user_created_at")
  @@index([uploadId], map: "idx_vibecut_jobs_upload_id")
  @@map("vibecut_jobs")
}

model EditorConfigVersion {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now()) @map("created_at")
  createdByUserId String?  @map("created_by_user_id")
  presetName      String?  @map("preset_name")
  params          Json
  isActive        Boolean  @default(false) @map("is_active")
  note            String?
  jobs            Job[]    @relation("JobAlgorithmConfig")
  metrics         RenderQualityMetric[]

  @@index([createdAt], map: "idx_editor_config_versions_created_at")
  @@index([isActive, createdAt], map: "idx_editor_config_versions_active_created_at")
  @@map("editor_config_versions")
}

model RenderQualityMetric {
  id              String   @id @default(uuid())
  jobId           String   @map("job_id")
  userId          String?  @map("user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  configVersionId String   @map("config_version_id")
  scoreTotal      Float    @map("score_total")
  scoreHook       Float    @map("score_hook")
  scorePacing     Float    @map("score_pacing")
  scoreEmotion    Float    @map("score_emotion")
  scoreVisual     Float    @map("score_visual")
  scoreStory      Float    @map("score_story")
  scoreJank       Float    @map("score_jank")
  features        Json
  flags           Json
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  configVersion   EditorConfigVersion @relation(fields: [configVersionId], references: [id], onDelete: Cascade)

  @@index([createdAt], map: "idx_render_quality_metrics_created_at")
  @@index([configVersionId], map: "idx_render_quality_metrics_config_version_id")
  @@map("render_quality_metrics")
}

model AlgorithmExperiment {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now()) @map("created_at")
  createdByUserId String?  @map("created_by_user_id")
  name            String
  status          String
  arms            Json
  allocation      Json
  rewardMetric    String   @default("score_total") @map("reward_metric")
  startAt         DateTime? @map("start_at")
  endAt           DateTime? @map("end_at")

  @@index([status, createdAt], map: "idx_algorithm_experiments_status_created_at")
  @@map("algorithm_experiments")
}

model SecurityEvent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  type      String
  meta      Json

  @@index([createdAt], map: "idx_security_events_created_at")
  @@index([type], map: "idx_security_events_type")
  @@map("security_events")
}

model FounderInventory {
  id             String   @id
  maxPurchases   Int      @default(100) @map("max_purchases")
  purchasedCount Int      @default(0) @map("purchased_count")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("founder_inventory")
}

model UserSettings {
  userId         String   @id
  defaultPreset  String?
  autoCaptions   Boolean  @default(false)
  autoHookMove   Boolean  @default(true)
  removeBoring   Boolean  @default(true)
  onlyCuts       Boolean  @default(false)
  smartZoom      Boolean  @default(true)
  jumpCuts       Boolean  @default(true)
  transitions    Boolean  @default(true)
  soundFx        Boolean  @default(true)
  emotionalBoost Boolean  @default(true)
  musicDuck      Boolean  @default(true)
  aggressiveMode Boolean  @default(false)
  subtitleStyle  String?  @default("basic_clean")
  autoZoomMax    Float?   @default(1.1)
  watermarkEnabled Boolean @default(true)
  exportQuality  String?  @default("720p")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model ExportCounter {
  userId       String   @id
  exportsUsed  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
}

model UsageDaily {
  userId   String
  date     String
  chatCount Int     @default(0)
  rizzCount Int     @default(0)
  rerenderCount Int @default(0)
  @@id([userId, date])
  user     User @relation(fields: [userId], references: [id])
}

model UsageMonthly {
  id         String   @id @default(uuid())
  userId     String
  month      String
  rendersUsed Int     @default(0) @map("renders_used")
  minutesUsed Int     @default(0) @map("minutes_used")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User @relation(fields: [userId], references: [id])

  @@unique([userId, month])
  @@map("usage_monthly")
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  stripeCustomerId     String?  @unique @map("stripe_customer_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  status               String
  planTier             PlanTier @default(free) @map("plan_tier")
  priceId              String?  @map("price_id")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @default(false) @map("cancel_at_period_end")
  updatedAt            DateTime @updatedAt @map("updated_at")
  user                 User     @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model Lesson {
  id         String   @id @default(cuid())
  title      String
  category   String?
  contentJson String
  isPremium  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
}

model LessonProgress {
  id         String   @id @default(cuid())
  userId     String
  lessonId   String
  completedAt DateTime?
  user       User     @relation(fields: [userId], references: [id])
  @@index([userId])
}

model SiteAnalyticsEvent {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  sessionId        String?  @map("session_id")
  eventName        String   @map("event_name")
  category         String   @default("interaction")
  pagePath         String?  @map("page_path")
  retentionProfile String?  @map("retention_profile")
  targetPlatform   String?  @map("target_platform")
  captionStyle     String?  @map("caption_style")
  jobId            String?  @map("job_id")
  metadata         Json?
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt], map: "idx_site_analytics_events_created_at")
  @@index([eventName], map: "idx_site_analytics_events_event_name")
  @@index([category], map: "idx_site_analytics_events_category")
  @@index([userId], map: "idx_site_analytics_events_user_id")
  @@map("site_analytics_events")
}

model AdminAudit {
  id         String   @id @default(uuid())
  actor      String?
  action     String
  targetEmail String
  planKey    String?
  reason     String?
  createdAt  DateTime @default(now())

  @@map("admin_audit")
}

model BannedIp {
  ip        String   @id
  reason    String?
  createdBy String?  @map("created_by")
  active    Boolean  @default(true)
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banned_ips")
}

model WeeklyReportSubscription {
  id         String   @id @default(uuid())
  email      String   @unique
  enabled    Boolean  @default(true)
  createdBy  String?  @map("created_by")
  lastSentAt DateTime? @map("last_sent_at")
  nextSendAt DateTime? @map("next_send_at")
  lastError  String?  @map("last_error")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("weekly_report_subscriptions")
}
