generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanStatus {
  free
  active
  past_due
  canceled
}

enum PlanTier {
  free
  starter
  creator
  studio
}

enum JobStatus {
  queued
  uploading
  analyzing
  hooking
  cutting
  pacing
  rendering
  completed
  failed
}

model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  createdAt             DateTime @default(now()) @map("created_at")
  stripeCustomerId      String?  @map("stripe_customer_id")
  stripeSubscriptionId  String?  @map("stripe_subscription_id")
  stripePriceId         String?  @map("stripe_price_id")
  planStatus            PlanStatus @default(free) @map("plan_status")
  currentPeriodEnd      DateTime? @map("current_period_end")
  settings              UserSettings?
  jobs                  Job[]
  usageDaily            UsageDaily[]
  usageMonthly          UsageMonthly[]
  subscription          Subscription?
  exportCounter         ExportCounter?
  lessonProgress        LessonProgress[]

  @@map("profiles")
}

model Job {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  status     JobStatus @default(queued)
  inputPath  String   @map("input_url")
  outputPath String?  @map("output_url")
  inputDurationSeconds Int? @map("input_duration_seconds")
  requestedQuality String? @map("requested_quality")
  finalQuality String? @map("final_quality")
  watermarkApplied Boolean @default(false) @map("watermark_applied")
  priority   Boolean @default(false)
  progress   Int      @default(0)
  error      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("jobs")
}

model UserSettings {
  userId         String   @id
  defaultPreset  String?
  autoCaptions   Boolean  @default(false)
  watermarkEnabled Boolean @default(true)
  exportQuality  String?  @default("720p")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model ExportCounter {
  userId       String   @id
  exportsUsed  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
}

model UsageDaily {
  userId   String
  date     String
  chatCount Int     @default(0)
  rizzCount Int     @default(0)
  @@id([userId, date])
  user     User @relation(fields: [userId], references: [id])
}

model UsageMonthly {
  id         String   @id @default(uuid())
  userId     String
  month      String
  rendersUsed Int     @default(0) @map("renders_used")
  minutesUsed Int     @default(0) @map("minutes_used")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User @relation(fields: [userId], references: [id])

  @@unique([userId, month])
  @@map("usage_monthly")
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  stripeCustomerId     String?  @unique @map("stripe_customer_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  status               String
  planTier             PlanTier @default(free) @map("plan_tier")
  priceId              String?  @map("price_id")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @default(false) @map("cancel_at_period_end")
  updatedAt            DateTime @updatedAt @map("updated_at")
  user                 User     @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model Lesson {
  id         String   @id @default(cuid())
  title      String
  category   String?
  contentJson String
  isPremium  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
}

model LessonProgress {
  id         String   @id @default(cuid())
  userId     String
  lessonId   String
  completedAt DateTime?
  user       User     @relation(fields: [userId], references: [id])
  @@index([userId])
}
